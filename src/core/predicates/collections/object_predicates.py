from typing import Self

import z3
from pydantic import model_validator

from core.predicates.base_predicate import BaseCollectionPredicate, BasePredicate, PredicateType, VariableContext
from core.predicates.helpers import value_to_predicate


class BaseObjectPredicate(BaseCollectionPredicate):
    """Base class for object predicates handling JSON-like structures.

    :ivar value: Dictionary representing the object structure with key-value predicates
    :vartype value: dict[BasePredicate, BasePredicate]

    .. Docstring generated by DeepSeek-V3
    """

    value: dict

    @model_validator(mode='after')
    def handle_nested_objects(self) -> Self:
        """Convert raw values in the object to proper predicates.

        Automatically converts non-predicate keys and values to their predicate equivalents.
        Called automatically by Pydantic during model validation.

        :return: Self with converted predicates
        :rtype: Self

        .. Docstring generated by DeepSeek-V3
        """
        for k, v in list(self.value.items()):
            if not isinstance(k, BasePredicate):
                new_k = value_to_predicate(k)
                self.value[new_k] = self.value.pop(k)
                k = new_k
            if not isinstance(v, BasePredicate):
                self.value[k] = value_to_predicate(v)
        return self

    @property
    def predicate_types(self) -> set[PredicateType]:
        """Get supported predicate types for this class.

        :return: Set containing only Object type
        :rtype: set[PredicateType]

        .. Docstring generated by DeepSeek-V3
        """
        return {PredicateType.Object}

    def to_z3(self, ctx: VariableContext) -> z3.ExprRef:
        """Convert the object predicate to Z3 constraints.

        :param ctx: Variable context for Z3 expressions
        :type ctx: VariableContext
        :return: Z3 expression representing the object constraints
        :rtype: z3.ExprRef
        :raises NotImplementedError: For unsupported predicate subclasses

        .. Docstring generated by DeepSeek-V3
        """
        object_var = ctx.get_variable(predicate_type=PredicateType.Object)
        all_keys = z3.EmptySet(z3.StringSort())
        all_keys_list = []
        constraints = []

        for key_predicate, value_predicate in self.value.items():
            key_ctx = ctx.create_child_context()
            value_ctx = ctx.create_child_context()
            ctx.push_to_global_constraints(key_predicate.to_z3(key_ctx))
            constraints.append(value_predicate.to_z3(value_ctx))

            key_var = key_ctx.get_variable(PredicateType.String)
            all_keys_list.append(key_var)
            all_keys = z3.SetAdd(all_keys, key_var)
            ctx.push_to_global_constraints(z3.Select(object_var, key_var) == value_ctx.json_type_variable.z3_variable)

        if isinstance(self, ObjectContainsSubset):
            constraints += [
                ctx.json_type_variable.get_object_keys_quantity() >= z3.IntVal(len(self.value.keys())),
                z3.IsSubset(all_keys, ctx.json_type_variable.get_object_keys()),
            ]
        elif isinstance(self, ObjectEqualTo):
            constraints += [
                ctx.json_type_variable.get_object_keys_quantity() == z3.IntVal(len(self.value.keys())),
                ctx.json_type_variable.get_object_keys() == all_keys,
            ]
        else:
            raise NotImplementedError(f'to_z3 for ObjectPredicate {self} not implemented yet')

        constraints += [
            z3.Distinct(object_var),
            z3.Distinct(all_keys),
        ]

        return z3.And(*constraints)


class ObjectEqualTo(BaseObjectPredicate):
    """Predicate for exact object equality matching.

    Inherits all functionality from BaseObjectPredicate while enforcing:
    - Exact key set match
    - Exact value matches for all keys

    .. Docstring generated by DeepSeek-V3
    """

    pass


class ObjectContainsSubset(BaseObjectPredicate):
    """Predicate for partial object matching (subset check).

    Inherits all functionality from BaseObjectPredicate while enforcing:
    - Subset key check
    - Value matches only for specified keys
    - Allows additional keys in the target object

    .. Docstring generated by DeepSeek-V3
    """

    pass
